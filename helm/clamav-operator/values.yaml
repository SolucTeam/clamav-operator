# Default values for clamav-operator.
# This is a YAML-formatted file.
# Declare variables to be passed into your templates.

# Operator configuration
operator:
  # Number of operator replicas
  replicaCount: 1
  
  image:
    repository: registry.tooling.cloudgouv-eu-west-1.numspot.cloud/platform-iac/clamav-operator
    pullPolicy: IfNotPresent
    # Overrides the image tag whose default is the chart appVersion.
    tag: ""
  
  imagePullSecrets:
    - name: numspot-registry
  
  nameOverride: ""
  fullnameOverride: ""
  
  serviceAccount:
    # Specifies whether a service account should be created
    create: true
    # Automatically mount a ServiceAccount's API credentials?
    automount: true
    # Annotations to add to the service account
    annotations: {}
    # The name of the service account to use.
    # If not set and create is true, a name is generated using the fullname template
    name: ""
  
  podAnnotations: {}
  podLabels: {}
  
  podSecurityContext:
    runAsNonRoot: true
    runAsUser: 65532
    runAsGroup: 65532
    fsGroup: 65532
  
  securityContext:
    allowPrivilegeEscalation: false
    capabilities:
      drop:
      - ALL
    readOnlyRootFilesystem: true
    runAsNonRoot: true
    runAsUser: 65532
  
  # Service for metrics
  service:
    type: ClusterIP
    port: 8080
    metricsPort: 8080
    healthPort: 8081
  
  resources:
    limits:
      cpu: 500m
      memory: 256Mi
    requests:
      cpu: 100m
      memory: 128Mi
  
  # Leader election settings
  leaderElection:
    enabled: true
    leaseDuration: 15s
    renewDeadline: 10s
    retryPeriod: 2s
  
  # Node selector for operator pod
  nodeSelector: {}
  
  tolerations: []
  
  affinity: {}
  
  # Priority class name
  priorityClassName: ""

# ClamAV scanner configuration
scanner:
  image:
    repository: registry.tooling.cloudgouv-eu-west-1.numspot.cloud/platform-runtime/clamav-node-scanner
    tag: "1.0.3"
    pullPolicy: IfNotPresent
  
  # ClamAV service configuration
  clamav:
    host: clamav.clamav.svc.cluster.local
    port: 3310
  
  # ServiceAccount for scanner jobs
  serviceAccount:
    create: true
    name: clamav-scanner
    annotations: {}
  
  # Default resources for scanner jobs
  resources:
    requests:
      cpu: 500m
      memory: 512Mi
    limits:
      cpu: 2000m
      memory: 1Gi
  
  # Image pull secrets for scanner jobs
  imagePullSecrets:
    - name: numspot-registry

# Custom Resource Definitions
crds:
  # Install CRDs as part of helm install
  install: true
  # Keep CRDs on helm uninstall
  keep: true

# RBAC configuration
rbac:
  # Create RBAC resources
  create: true
  
  # ClusterRole rules for the operator
  clusterRoleRules:
    - apiGroups:
        - ""
      resources:
        - nodes
      verbs:
        - get
        - list
        - watch
    - apiGroups:
        - ""
      resources:
        - events
      verbs:
        - create
        - patch
    - apiGroups:
        - ""
      resources:
        - pods
        - pods/log
      verbs:
        - get
        - list
    - apiGroups:
        - batch
      resources:
        - jobs
      verbs:
        - create
        - get
        - list
        - watch
        - update
        - patch
        - delete
    - apiGroups:
        - clamav.platform.numspot.com
      resources:
        - nodescans
        - clusterscans
        - scanpolicies
        - scanschedules
      verbs:
        - create
        - delete
        - get
        - list
        - patch
        - update
        - watch
    - apiGroups:
        - clamav.platform.numspot.com
      resources:
        - nodescans/finalizers
        - clusterscans/finalizers
        - scanpolicies/finalizers
        - scanschedules/finalizers
      verbs:
        - update
    - apiGroups:
        - clamav.platform.numspot.com
      resources:
        - nodescans/status
        - clusterscans/status
        - scanpolicies/status
        - scanschedules/status
      verbs:
        - get
        - patch
        - update

# Webhook configuration
webhook:
  enabled: true
  port: 9443
  
  # Certificate management
  certManager:
    enabled: false
  
  # If certManager is disabled, use these certificates
  certificates:
    # Auto-generate self-signed certificates
    autoGenerate: true
    # Or provide your own
    caBundle: ""
    tlsCert: ""
    tlsKey: ""

# Monitoring configuration
monitoring:
  # Enable ServiceMonitor for Prometheus Operator
  serviceMonitor:
    enabled: true
    # Prometheus instance selector
    selector:
      prometheus: kube-prometheus
    # Scrape interval
    interval: 30s
    # Scrape timeout
    scrapeTimeout: 30s
    # Additional labels
    labels: {}
    # Honorlabels
    honorLabels: false
  
  # Enable PrometheusRule for alerts
  prometheusRule:
    enabled: true
    # Additional labels
    labels: {}
    # Alert rules
    rules:
      - alert: ClamAVMalwareDetected
        expr: increase(clamav_files_infected_total[5m]) > 0
        for: 1m
        labels:
          severity: critical
          team: security
        annotations:
          summary: "Malware detected on node {{ $labels.node }}"
          description: "{{ $value }} infected files detected"
      
      - alert: ClamAVScanFailed
        expr: clamav_nodescan_failed > 0
        for: 5m
        labels:
          severity: warning
          team: platform
        annotations:
          summary: "ClamAV scan failed"
          description: "{{ $value }} scans have failed"
      
      - alert: ClamAVNoRecentScans
        expr: time() - clamav_nodescan_last_completion_timestamp > 86400
        for: 1h
        labels:
          severity: warning
          team: platform
        annotations:
          summary: "No recent ClamAV scans"
          description: "No scans completed in the last 24 hours"

# Default ScanPolicy to create
defaultScanPolicy:
  enabled: true
  name: default-policy
  spec:
    paths:
      - /var/lib
      - /opt
      - /usr/local
    excludePatterns:
      - "*.tmp"
      - "*.log"
      - "/var/lib/docker/overlay2/*"
      - "/var/lib/containerd/*"
    maxConcurrent: 5
    fileTimeout: 300000
    maxFileSize: 524288000
    resources:
      requests:
        cpu: 500m
        memory: 512Mi
      limits:
        cpu: 2000m
        memory: 1Gi

# Network policies
networkPolicy:
  enabled: false
  policyTypes:
    - Ingress
    - Egress
  ingress:
    - from:
      - namespaceSelector:
          matchLabels:
            name: monitoring
      ports:
      - protocol: TCP
        port: 8080
  egress:
    - to:
      - namespaceSelector: {}
      ports:
      - protocol: TCP
        port: 6443  # Kubernetes API
    - to:
      - namespaceSelector:
          matchLabels:
            name: clamav
      ports:
      - protocol: TCP
        port: 3310  # ClamAV

# Additional environment variables for the operator
env: []
# - name: LOG_LEVEL
#   value: "debug"

# Additional volumes
volumes: []

# Additional volume mounts
volumeMounts: []
