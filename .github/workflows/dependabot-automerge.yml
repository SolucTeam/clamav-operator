# =============================================================================
# Auto-merge Dependabot PRs
# =============================================================================
# Fusionne automatiquement les PRs de Dependabot si :
#   1. Les tests passent avec succ√®s
#   2. C'est une mise √† jour mineure ou patch (pas majeure)
#   3. Les checks de s√©curit√© passent
#
# Les mises √† jour majeures n√©cessitent toujours une revue manuelle
# =============================================================================

name: Dependabot Auto-merge

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: write
  pull-requests: write

jobs:
  # ===========================================================================
  # Job 1 - V√©rifier si c'est une PR Dependabot √©ligible
  # ===========================================================================
  check-dependabot:
    name: Check Dependabot PR
    runs-on: ubuntu-latest
    if: github.actor == 'dependabot[bot]'
    outputs:
      is_eligible: ${{ steps.check.outputs.is_eligible }}
      update_type: ${{ steps.metadata.outputs.update-type }}
    steps:
      - name: Dependabot metadata
        id: metadata
        uses: dependabot/fetch-metadata@v1
        with:
          github-token: "${{ secrets.GITHUB_TOKEN }}"

      - name: Check if eligible for auto-merge
        id: check
        run: |
          UPDATE_TYPE="${{ steps.metadata.outputs.update-type }}"
          
          echo "Update type: $UPDATE_TYPE"
          
          # Auto-merge seulement pour patch et minor
          if [[ "$UPDATE_TYPE" == "version-update:semver-patch" ]] || \
             [[ "$UPDATE_TYPE" == "version-update:semver-minor" ]]; then
            echo "‚úÖ Eligible for auto-merge (update type: $UPDATE_TYPE)"
            echo "is_eligible=true" >> $GITHUB_OUTPUT
          else
            echo "‚ùå Not eligible for auto-merge (update type: $UPDATE_TYPE)"
            echo "‚ÑπÔ∏è  Major updates require manual review"
            echo "is_eligible=false" >> $GITHUB_OUTPUT
          fi

  # ===========================================================================
  # Job 2 - Attendre que tous les checks passent
  # ===========================================================================
  wait-for-checks:
    name: Wait for Checks
    runs-on: ubuntu-latest
    needs: check-dependabot
    if: needs.check-dependabot.outputs.is_eligible == 'true'
    steps:
      - name: Wait for required checks
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const requiredChecks = [
              'Lint & Test',
              'Build: clamav-operator',
              'Build: clamav-node-scanner'
            ];
            
            const maxAttempts = 60; // 30 minutes max (30 secondes * 60)
            let attempt = 0;
            
            while (attempt < maxAttempts) {
              attempt++;
              
              console.log(`Attempt ${attempt}/${maxAttempts}: Checking status...`);
              
              // R√©cup√©rer les check runs pour ce commit
              const { data: checkRuns } = await github.rest.checks.listForRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: '${{ github.event.pull_request.head.sha }}'
              });
              
              // V√©rifier le statut des checks requis
              const checkStatuses = {};
              for (const check of checkRuns.check_runs) {
                if (requiredChecks.includes(check.name)) {
                  checkStatuses[check.name] = {
                    status: check.status,
                    conclusion: check.conclusion
                  };
                }
              }
              
              // Afficher l'√©tat actuel
              console.log('Check statuses:', JSON.stringify(checkStatuses, null, 2));
              
              // V√©rifier si tous les checks requis sont termin√©s
              const allCompleted = requiredChecks.every(name => 
                checkStatuses[name] && checkStatuses[name].status === 'completed'
              );
              
              if (!allCompleted) {
                console.log('Some checks are still running, waiting 30 seconds...');
                await new Promise(resolve => setTimeout(resolve, 30000));
                continue;
              }
              
              // V√©rifier si tous les checks ont r√©ussi
              const allSuccess = requiredChecks.every(name =>
                checkStatuses[name] && checkStatuses[name].conclusion === 'success'
              );
              
              if (allSuccess) {
                console.log('‚úÖ All required checks passed!');
                return;
              }
              
              // Si des checks ont √©chou√©
              const failedChecks = requiredChecks.filter(name =>
                checkStatuses[name] && checkStatuses[name].conclusion !== 'success'
              );
              
              console.log('‚ùå Some checks failed:', failedChecks);
              throw new Error(`Required checks failed: ${failedChecks.join(', ')}`);
            }
            
            throw new Error('Timeout waiting for checks to complete');

  # ===========================================================================
  # Job 3 - Approuver et merger la PR
  # ===========================================================================
  auto-merge:
    name: Auto-merge PR
    runs-on: ubuntu-latest
    needs: [check-dependabot, wait-for-checks]
    if: needs.check-dependabot.outputs.is_eligible == 'true'
    steps:
      - name: Enable auto-merge
        run: |
          gh pr merge "$PR_URL" --auto --squash --delete-branch
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Comment on PR
        uses: actions/github-script@v8
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: 'ü§ñ **Auto-merge enabled**\n\n' +
                    'Cette PR sera automatiquement fusionn√©e d√®s que tous les checks seront au vert.\n\n' +
                    '**Type de mise √† jour :** `${{ needs.check-dependabot.outputs.update_type }}`\n' +
                    '**Strat√©gie :** Squash merge avec suppression de la branche\n\n' +
                    '‚ö†Ô∏è _Note: GitHub Actions ne peut pas approuver automatiquement les PRs._\n' +
                    '_Si une approbation manuelle est requise par les branch protections, veuillez approuver manuellement._'
            });

  # ===========================================================================
  # Job 4 - Notifier si la PR n'est pas √©ligible
  # ===========================================================================
  notify-manual-review:
    name: Notify Manual Review Required
    runs-on: ubuntu-latest
    needs: check-dependabot
    if: |
      github.actor == 'dependabot[bot]' && 
      needs.check-dependabot.outputs.is_eligible == 'false'
    steps:
      - name: Comment on PR
        uses: actions/github-script@v8
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: '‚ö†Ô∏è **Revue manuelle requise**\n\n' +
                    'Cette PR contient une mise √† jour majeure et n√©cessite une revue manuelle.\n\n' +
                    '**Type de mise √† jour :** `${{ needs.check-dependabot.outputs.update_type }}`\n\n' +
                    '**Actions √† effectuer :**\n' +
                    '1. ‚úÖ V√©rifier les breaking changes dans le changelog\n' +
                    '2. ‚úÖ Tester localement si n√©cessaire\n' +
                    '3. ‚úÖ V√©rifier que tous les tests passent\n' +
                    '4. ‚úÖ Approuver et merger manuellement'
            });

      - name: Add label
        uses: actions/github-script@v8
        with:
          script: |
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['needs-review', 'major-update']
            });