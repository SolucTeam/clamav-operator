# =============================================================================
# Validation des Commits (Conventional Commits)
# =============================================================================
# VÃ©rifie que tous les commits suivent le format Conventional Commits
#
# Format attendu :
#   type(scope?): description
#
# Types valides :
#   - feat:     nouvelle fonctionnalitÃ©
#   - fix:      correction de bug
#   - docs:     documentation
#   - style:    formatage, espaces, etc
#   - refactor: refactoring du code
#   - perf:     amÃ©lioration des performances
#   - test:     ajout/modification de tests
#   - build:    systÃ¨me de build, dÃ©pendances
#   - ci:       CI/CD, workflows
#   - chore:    tÃ¢ches diverses
#
# Exemples valides :
#   feat: add auto-release workflow
#   fix(scanner): correct memory leak in scan job
#   docs: update installation guide
#   feat!: breaking change in API
# =============================================================================

name: Commit Validation

on:
  pull_request:
    types: [opened, synchronize, reopened, edited]
  push:
    branches:
      - main
      - develop
      - 'feature/**'
      - 'fix/**'

jobs:
  # ===========================================================================
  # Job 1 - Valider les messages de commit
  # ===========================================================================
  validate-commits:
    name: Validate Commit Messages
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # NÃ©cessaire pour voir tous les commits

      - name: Validate commit messages
        run: |
          #!/bin/bash
          set -e
          
          echo "ğŸ” Validating commit messages..."
          echo ""
          
          # Pattern pour Conventional Commits
          PATTERN='^(feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert)(\(.+\))?(!)?: .{1,100}'
          
          # Obtenir la liste des commits Ã  vÃ©rifier
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
            HEAD_SHA="${{ github.event.pull_request.head.sha }}"
            COMMITS=$(git rev-list $BASE_SHA..$HEAD_SHA)
            
            # VÃ©rifier si c'est une PR de Dependabot
            if [ "${{ github.actor }}" = "dependabot[bot]" ]; then
              echo "âœ… Dependabot PR - commits are automatically validated"
              exit 0
            fi
          else
            # Pour un push, vÃ©rifier seulement le dernier commit
            COMMITS="${{ github.sha }}"
          fi
          
          INVALID_COMMITS=()
          VALID_COUNT=0
          
          for COMMIT in $COMMITS; do
            MESSAGE=$(git log -1 --format=%s $COMMIT)
            COMMIT_SHORT=$(git rev-parse --short $COMMIT)
            
            # Accepter les commits de merge automatiques de GitHub
            if echo "$MESSAGE" | grep -qE '^Merge (branch|pull request) '; then
              echo "âœ… $COMMIT_SHORT: $MESSAGE (merge commit)"
              VALID_COUNT=$((VALID_COUNT + 1))
            elif echo "$MESSAGE" | grep -qE "$PATTERN"; then
              echo "âœ… $COMMIT_SHORT: $MESSAGE"
              VALID_COUNT=$((VALID_COUNT + 1))
            else
              echo "âŒ $COMMIT_SHORT: $MESSAGE"
              INVALID_COMMITS+=("$COMMIT_SHORT: $MESSAGE")
            fi
          done
          
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          if [ ${#INVALID_COMMITS[@]} -eq 0 ]; then
            echo "âœ… All $VALID_COUNT commit(s) follow Conventional Commits format"
            exit 0
          else
            echo "âŒ Found ${#INVALID_COMMITS[@]} invalid commit(s):"
            echo ""
            for COMMIT in "${INVALID_COMMITS[@]}"; do
              echo "  â€¢ $COMMIT"
            done
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo ""
            echo "â„¹ï¸  Conventional Commits Format:"
            echo ""
            echo "   type(scope?): description"
            echo ""
            echo "   Valid types: feat, fix, docs, style, refactor, perf,"
            echo "                test, build, ci, chore, revert"
            echo ""
            echo "   Examples:"
            echo "     feat: add new scanner mode"
            echo "     fix(api): correct validation error"
            echo "     docs: update README with examples"
            echo "     feat!: breaking change in configuration"
            echo "     build(deps): bump package version"
            echo ""
            echo "   Note: Merge commits from GitHub are automatically accepted"
            echo ""
            echo "   Learn more: https://www.conventionalcommits.org"
            echo ""
            exit 1
          fi

  # ===========================================================================
  # Job 2 - Valider le titre de la PR
  # ===========================================================================
  validate-pr-title:
    name: Validate PR Title
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Check PR title
        uses: amannn/action-semantic-pull-request@v5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          types: |
            feat
            fix
            docs
            style
            refactor
            perf
            test
            build
            ci
            chore
            revert
          requireScope: false
          # Supprimer la rÃ¨gle de majuscule pour supporter Dependabot
          # subjectPattern: ^[A-Z].+$
          # subjectPatternError: |
          #   Le sujet doit commencer par une majuscule.
          wip: false

  # ===========================================================================
  # Job 3 - VÃ©rifier que la branche suit les conventions de nommage
  # ===========================================================================
  validate-branch:
    name: Validate Branch Name
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Check branch name
        run: |
          BRANCH="${{ github.head_ref }}"
          
          echo "ğŸ” Validating branch name: $BRANCH"
          echo ""
          
          # Accepter les branches des bots de dÃ©pendances
          if echo "$BRANCH" | grep -qE '^(dependabot|renovate)/'; then
            echo "âœ… Dependency bot branch: $BRANCH"
            exit 0
          fi
          
          # Pattern pour les noms de branches normales
          if echo "$BRANCH" | grep -qE '^(feature|feat|fix|hotfix|refactor|docs|test|chore)/[a-z0-9-]+$'; then
            echo "âœ… Branch name follows conventions"
            echo ""
            echo "Branch: $BRANCH"
          elif echo "$BRANCH" | grep -qE '^(main|master|develop|development|staging|production)$'; then
            echo "âœ… Protected branch: $BRANCH"
          else
            echo "âŒ Invalid branch name: $BRANCH"
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo ""
            echo "â„¹ï¸  Branch Naming Convention:"
            echo ""
            echo "   type/description-in-kebab-case"
            echo ""
            echo "   Valid types: feature, feat, fix, hotfix, refactor, docs, test, chore"
            echo ""
            echo "   Examples:"
            echo "     feature/add-auto-release"
            echo "     fix/scanner-memory-leak"
            echo "     docs/update-readme"
            echo "     refactor/cleanup-controllers"
            echo ""
            echo "   Note: Branches from Dependabot and Renovate are automatically accepted"
            echo ""
            exit 1
          fi

  # ===========================================================================
  # Job 4 - VÃ©rifier les fichiers modifiÃ©s
  # ===========================================================================
  check-files:
    name: Check Modified Files
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v41

      - name: Check for sensitive files
        run: |
          SENSITIVE_FILES=(
            ".env"
            "*.key"
            "*.pem"
            "*.crt"
            "*secret*"
            "*password*"
            "*.p12"
            "*.pfx"
          )
          
          echo "ğŸ” Checking for sensitive files..."
          echo ""
          
          FOUND_SENSITIVE=false
          
          for FILE in ${{ steps.changed-files.outputs.all_changed_files }}; do
            for PATTERN in "${SENSITIVE_FILES[@]}"; do
              if [[ "$FILE" == $PATTERN ]]; then
                echo "âš ï¸  WARNING: Potentially sensitive file detected: $FILE"
                FOUND_SENSITIVE=true
              fi
            done
          done
          
          echo ""
          
          if [ "$FOUND_SENSITIVE" = true ]; then
            echo "âš ï¸  Please verify that no secrets are committed"
            echo ""
            echo "If these files are intentional, you can:"
            echo "  1. Add them to .gitignore"
            echo "  2. Use git-secrets or similar tools"
            echo "  3. Store secrets in GitHub Secrets"
          else
            echo "âœ… No sensitive files detected"
          fi